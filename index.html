<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Permutation Test: Visual Explanation</title>
	<meta name="description" content="Scrollama Demo: Fixed CSS">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js'></script>
	<link rel="stylesheet" href="permutationTest.css">
	<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=default'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/rough.js/2.2.5/rough.min.js"></script>
	<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.4/seedrandom.min.js"></script>
	<!-- <script src=assets/d3v4.js></script> -->
	<stylesheet href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
	<!-- <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Just+Me+Again+Down+Here" /> -->
	<style>
    @import 'https://fonts.googleapis.com/css?family=Indie+Flower';

	</style>
 


</head>

<body>
	<section id='intro'>
		<p class='intro__overline'>
			February 2019 By <a href='https://twitter.com/jdwlbr'>Jared Wilber</a>
		</p>
		<h1 class='intro__hed'>The Permutation Test</h1>
		<p class='intro__dek'>
			A Visual Explanation of Statistical Testing
		</p>
		<p class='intro__bod'>
			Statistics is big right now, and <i>nothing</i> in the field is hotter than statistical testing.*
			<!-- <span class='tooltip'>*<span class="tooltiptext"></span></span> -->
			<span class="sidenote"><span style='font-size:25px;'>*</span> <i>Everything</i> in the field is hotter than statistical testing.</span>
			Statistical tests, also known as hypothesis tests, are used in the design of experiments to measure the <i>effect</i> of some <i>treatment(s)</i> on <i>experimental units</i>. For example, we may wish to determine if drug A reduces the symptoms of a new virus, or whether or not Facebook's LIKE button using <span class="fb_highlight_one">this blue</span> instead of <span class="fb_highlight_two">this blue</span> yields a higher number of clicks. 
			<br><br>
		<!-- 	Unfortunately, the majority of testing methods taught in introductory statistics courses are unintuitive. That's why I'm writing about the coolest test around - the permutation test.
			The permutation test is a nonparametric statistical test. This means is has less assumptions underpinning it than other popular tests, and is 
			Unlike other testing methods, and, the one test to rule them all.
			But they're not all like this. In fact, there exists one test to rule them all,  -->
			Unfortunately, a lot of statistical tests require complex assumptions and convoluted formula. They are uninspiring and unintuitive. This is especially true of those methods taught in introductory courses, leading to the false impression that experimental design is boring and unintuitive. 
			But what if I told you not all tests were like this? In fact, what if i told you that there exists one test to rule them all - a test that is intuitive, effective, and (<i>inhales deeply</i>) interesting.
		</p>

	</section>
	<section id='scroll'>
		<div class='scroll__graphic'>
			<div class='chart'>
				<!-- <svg style="width:100%;height:100%;"> -->
				<svg id='svg' style="width:100%;height:100%;"></svg>

			</div>
		</div>
		<div class='scroll__text'>
			<div class='step' data-step='1'>
				<h2 class="subheader">You're a Llama Shepherd, Harry</h2>
				<p>
 				You've finally made it as a llama herder and would like to determine if a popular new llama diet increases the wool quality of your llamas.<br><br>
 				In statistical testing, experiments are often structured in terms of <a href="https://en.wikipedia.org/wiki/Statistical_hypothesis_testing#The_testing_process">null & alternative</a> hypotheses.
 				<br><br> We'll develop a statistical test to see if the diet does effect the quality of our llama wool.<br><br>
 				Our test will have the following hypothesis schema<b>:</b>
				$$ {H_0: \mu_{treatment} = \mu_{control}} $$
				$$ {H_A: \mu_{treatment} \neq \mu_{control}} $$
				Our null hypothesis claims that the new llama diet has no effect<b>;</b> both the regular diet and the new diet yield the same wool quality. The alternative claims the opposite: different diets yield differences in wool quality.<br><br>
<!-- 				We determine the experiment's results via a <a href="">p-value</a>. More on those soon.
 -->			</p>
				

 			
			</div>
			<div class='step' data-step='2'>
				<h2 class='subheader'>Randomization</h2>
				<p>Before carrying out our experiment, we must randomly assign half of our llamas to the new diet, and half to the old. <br><br>
				We say that the llamas receiving the new diet belong to the <i>treatment</i> group, and the other llamas to the <i>control</i> group. The assignment of a llama to a given diet is known as its <i>treatment assignment</i>.
				<br><br>
				Randomization of treatment assignment is very important. It removes bias and conofunding from our results, and provides the basis for the theory underpinning our statistical test.
				</p>
			</div>
			<br>
			<br>
			<div class='step' data-step='3'>
				<br>
				<br><br><br><br><br><br>
				<h2 class='subheader'>Response Values</h2>
				<p>
					After a sufficient amount of time has passed, we can begin to determine if the new diets had any effect.
					<br><br>
					In statistics jargon, every experimental unit receives a response value. 
					For us, that corresponds to each llama's measure of wool quality after the diet.
					<br><br>
					While we can eyeball these values and determine any perceived differences between the two diets, we'll
					have to create a <i>test statistic</i> to compare the diets with statistical rigor.
				 </p>
			</div>
			<div class='step' data-step='4'>
				<h2 class='subheader'>Test Statistic</h2>
				<p>
				Our <i>test statistic</i> is a numerical summary of our data that allows us to quantify the differences between our null and alternative hypotheses. 
				<br><br>
				A benefit of the permutation tests is that it allows us to use any numerical value that we want for our test statistic. Because our analysis is fairly straightforward, we'll simply use the difference in mean response values between the two diets:
				$$ {T = \mu_{treatment} - \mu_{control}} $$
				<br>
				<!-- As you'll soon see, this value will be used to obtain our <i>p-value</i>. -->
				Using our response values obtained earlier, we calculate our initial test statistic and save it for later.
				 </p>
			</div>
			<div class='step' data-step='5'>
				<h2 class='subheader'>The 'P' in  'Permutation Test'</h2>
				<p>
					This is the most important step in the permutation test, as well as its namesake.
					<br><br>
					While keeping the same response values we received earlier, we permute (shuffle) the treatment assignments of our llamas, and re-calculate our test statistic.
					<br><br>
					We do this because we analyze the results of our experiment relative to the null hypothesis, which posits both llama diets (the new and the original) as having identical effects on fleece quality. 
					<br><br>
					In other words, we think the new diet has no effect on the fleece quality of our llamas, so
					shuffling the diets of our llamas and recalculating our test statistic (without re-running our experiment) won't matter - we'll obtain similar fleece quality values for both groups.
					<br>
				</p>
			</div>
			<div class='step' data-step='6'>
				<h2 class='subheader'>More Permutations</h2>
				<p>
					Ideally, we'd recalculate our test statistics across all diet assignment permutations among our llamas, creating a distribution of <i>all</i> possible test statistic values.
					<br><br>
					Unfortunatley, this number is often <a href="https://en.wikipedia.org/wiki/Factorial">far too large</a> for practicality, so instead we resample <a href="">enough</a> permutations to build an approximation to our distribution. 
					<br><br>
					
					
				</p>
			</div>
			<div class='step' data-step='7'>
				<h2 class='subheader'>Test Statistic Distribution</h2>
				<p>
					Eventually, after a sufficient number of permutated test statistic calculations, we create a test statistic distribution.
					<br><br>
					This distribution approximates all possible mean-difference values we could have seen under the assumption that wool quality is independent of llama diet. 
					<br><br>By observing where our initial test statistic falls within this distribution, we obtain the final piece for our test: The magical <i>p-value</i>.
				</p>
			</div>
			<div class='step' data-step='8'>
				<h2 class='subheader'>The P-Value</h2>
				<p>
					The P-Value is simply the probability of observing the values we did, assuming the null hypothesis were true. For us, it's the probability of obtaining the differences in wool quality we did, assuming the diets did <i>not</i> affect wool quality. Thus, high p-values allow us to conclude that 

					<br><br>
					Calculating the p-value for a permutation test could not be simpler. We simply count the number of test-statistics <i> as or more extreme</i> than our initial test statistics, and divide that number by the total number of test-statistics we calculated.
				</p>
			</div>
			<div class='step' data-step='9'>
				<h2 class='subheader'>Our Results</h2>
				<p> Only nine out of our two-hundred test statistics were more extreme than our initial test statistic (which had a value of ). 
					<br><br> Thus, our p-value is:
					$$ \text{P-Value} = 9 \ / \ 200 $$
					$$ \ \ \approx 4\% $$
					In other words, if there really were no difference between the diets of our llamas, the probability of getting the differences in wool quality we did across the two diets is about four-percent. This is pretty unlikely, so we can determine that a tiny probability, and so unlikely* [in a real experiment, we call this threshold <i>level of significance</i>, and determine it a priori.] that we reject this original hypothesis and conclude that the new llama diet is having <i>some</i> effect on wool quality.
				</p>
			</div>
			
		</div>
	</section>
	<section id='intro'>
		<p><br></p><p><br></p><p><br></p>
		<h2 class='subheader'> Conclusion</h2>
		<p class='intro__bod'>
			So that's the permutation test. Pretty simple, huh? To recap, the algorithm only comprises three steps:</p>
			<br>
				<p class='intro__bod'>1). Determine & calculate initial test-statistic.</p>
				<p class='intro__bod'>2). Create permuted distribution of test statistics.</p>
				<p class='intro__bod'>3). Calculate the p-value.</p>
				<br>
			<p class='intro__bod'>
			Not only is it simple, but it requires much less assumptions than other testing methods, 
			Additionally, because it is nonparametric, it's free from the restriction of meeting particular assumptions for employment (e.g. sample size, ).

		</p>

		<br><br><br><hr><br>
		<h2 class='subheader'>References</h2>
		<p class='intro__bod'>
			<p class='intro__bod'><a href="https://www.wiley.com/en-us/Introduction+to+Design+and+Analysis+of+Experiments-p-9780470412169">Introduction to Design and Analysis of Experiments</a> (George W. Cobb, 1998)</p>
			<p class='intro__bod'><a href="http://allendowney.blogspot.com/2011/05/there-is-only-one-test.html">There is only one test!</a> (Allen Downey, 2011)</p>
			<p class='intro__bod'><a href="https://thomasleeper.com/Rcourse/Tutorials/permutationtests.html">Permutation Tests</a> (Thomas Leeper, 2013)</p>
		</p>
		<br><br>
		<h2 class='subheader'>Resources</h2>
		<p class='intro__bod'>
			<p class='intro__bod'><a href="https://github.com/russellgoldenberg/scrollama">scrollama.js</a> (Russel Goldenberg)</p>
			<p class='intro__bod'><a href="https://roughjs.com/">Rough.js</a> (Preet Shihn)</p>
			<p class='intro__bod'><a href="https://d3js.org/">D3.js</a> (Mike Bostock)</p>
		</p>
			
	</section>
	<div class='debug'></div>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/scrollama/1.3.0/scrollama.js'></script>
	<!-- <script src=assets/scrollama.js></script> -->
	<script>
		// seet seed so numbers are always the same
		Math.seedrandom('seed');

		var container = d3.select('#scroll');
		var graphic = container.select('.scroll__graphic');
		var chart = graphic.select('.chart');
		var text = container.select('.scroll__text');
		var step = text.selectAll('.step');

		var scroller = scrollama();

		// generic window resize listener event
		function handleResize() {
			// 1. update height of step elements
			var stepHeight = Math.floor(window.innerHeight * 0.9); // was * .75
			step.style('height', stepHeight + 'px');
			// 2. update width/height of graphic element
			var bodyWidth = d3.select('body').node().offsetWidth;
			graphic
				.style('width', bodyWidth + 'px')
				.style('height', window.innerHeight + 'px');
			var chartMargin = 32;
			var textWidth = text.node().offsetWidth;
			var chartWidth = graphic.node().offsetWidth - textWidth - chartMargin;
			chart
				.style('width', chartWidth + 'px')
				.style('height', Math.floor(window.innerHeight / 1.2) + 'px');
			// 3. tell scrollama to update new element dimensions
			scroller.resize();
		}

		// scrollama event handlers
		function handleStepEnter(response) {
			// add color to current step only
			step.classed('is-active', function (d, i) {
				return i === response.index;
			})

			// console.log('response index:' + response.index)

			if (response.index == 0 & response.direction == 'down') {
				console.log('0 down')
				transitionZeroDown()
			} else if (response.index == 0 & response.direction == 'up') {
				console.log('0 up')
				transitionZeroUp()
			}else if (response.index == 1 & response.direction == 'down') {
				console.log('1 down')
				transitionOneDown()
			} else if (response.index == 1 & response.direction == 'up') {
				console.log('1 up')
				transitionOneUp()
			} else if (response.index == 2 & response.direction == 'up') {
				console.log('2 up')
                transitionTwoUp()
           } else if (response.index == 2 & response.direction == 'down') {
           	    console.log('2 down')
                transitionTwoDown()
		   } else if (response.index == 3 & response.direction == 'up'){
			   	console.log('3 up')
			   	transitionThreeUp()
			   	moveNodes()
		   } else if (response.index == 3 & response.direction == 'down'){
		   		console.log('3 down')
		   		transitionThreeDown()
		   } else if (response.index == 4 & response.direction == 'up'){
			   	console.log('4 up')
			   	transitionFourUp()
		   } else if (response.index == 4 & response.direction == 'down'){
			   	console.log('4 down')
		   		transitionFourDown()
		   } else if (response.index == 5 & response.direction == 'up'){
			   	console.log('5 up')
			   	transitionFiveUp()
		   } else if (response.index == 5 & response.direction == 'down'){
			   	console.log('5 down')
			   	transitionFiveDown()
		   } else if (response.index == 6 & response.direction == 'up'){
			   	console.log('6 up')
			   	transitionSixUp()
		   } else if (response.index == 6 & response.direction == 'down'){
			   	console.log('6 down')
			   	transitionSixDown()
		   } else if (response.index == 7 & response.direction == 'up'){
			   	console.log('7 up')
			   	transitionSevenUp()
		   } else if (response.index == 7 & response.direction == 'down'){
			   	console.log('7 down')
			   	transitionSevenDown()
		   } else if (response.index == 8 & response.direction == 'up'){
			   	console.log('8 up')
			   	transitionEightUp()
		   } else if (response.index == 8 & response.direction == 'down'){
			   	console.log('8 down')
			   	transitionEightDown()
		   } else {
		   	console.log('else case, response index: ', response.index)
		   }
		 } 
		 // new 2down == 3down
		 // new threedown == fourdown
		 //new 4down == 2down
		 // make fourdown 2down

		function handleContainerEnter(response) {
			// response = { direction }
			// sticky the graphic (old school)
			graphic.classed('is-fixed', true);
			graphic.classed('is-bottom', false);
		}
		function handleContainerExit(response) {
			// response = { direction }
			// un-sticky the graphic, and pin to top/bottom of container
			graphic.classed('is-fixed', false);
			graphic.classed('is-bottom', response.direction === 'down');
			if (response.direction === 'down') {
				console.log('exit baby');
				transitionExit()
			}
		}

		function init() {
			// 1. force a resize on load to ensure proper dimensions are sent to scrollama
			handleResize();
			// 2. setup the scroller passing options
			// this will also initialize trigger observations
			// 3. bind scrollama event handlers (this can be chained like below)
			scroller.setup({
				container: '#scroll',
				graphic: '.scroll__graphic',
				text: '.scroll__text',
				step: '.scroll__text .step',
				debug: false,
			})
				.onStepEnter(handleStepEnter)
				.onContainerEnter(handleContainerEnter)
				.onContainerExit(handleContainerExit);
			// setup resize event
			window.addEventListener('resize', handleResize);
		}
		// kick things off
		init();
	</script>
	<script src="permTest.js"></script>
</body>

</html>
